# Cloudflare R2 存储配置说明

## 📦 功能说明

将通义万相生成的图片自动上传到Cloudflare R2存储桶，实现：
- ✅ 图片永久保存（不过期）
- ✅ 全球CDN加速访问
- ✅ 节省通义万相临时链接的限制
- ✅ 可自定义域名访问

---

## 🚀 快速开始

### 第一步：安装新依赖

```bash
npm install
```

这将安装以下新包：
- `@aws-sdk/client-s3` - AWS S3 SDK（R2兼容）
- `dotenv` - 环境变量管理
- `uuid` - 生成唯一文件名

---

### 第二步：配置R2公开访问

**重要**：R2存储桶默认是私有的，需要配置公开访问。

#### 方法A：使用自定义域名（推荐）

1. 登录Cloudflare控制台
2. 进入R2存储桶：`images`
3. 点击"设置" → "公共访问"
4. 连接自定义域名：
   ```
   例如：images.yourdomain.com
   ```
5. 等待DNS生效（1-5分钟）
6. 修改 `.env` 文件：
   ```
   R2_PUBLIC_URL=https://images.yourdomain.com
   ```

#### 方法B：使用R2.dev域名（快速测试）

1. 登录Cloudflare控制台
2. 进入R2存储桶：`images`
3. 点击"设置" → "公共访问"
4. 启用 `r2.dev` 子域
5. 获取公开URL（类似）：
   ```
   https://pub-xxxxxx.r2.dev
   ```
6. 修改 `.env` 文件：
   ```
   R2_PUBLIC_URL=https://pub-xxxxxx.r2.dev
   ```

---

### 第三步：启动新服务器

停止旧服务器（如果在运行）：
- 在PowerShell窗口按 `Ctrl + C`

启动新的R2版本服务器：

**方法A：使用启动脚本**
```bash
node server-with-r2.js
```

**方法B：更新主服务器**
如果想永久使用R2，可以：
```bash
# 备份旧服务器
copy server.js server-backup.js

# 使用R2版本
copy server-with-r2.js server.js

# 启动
node server.js
```

---

### 第四步：测试

1. 打开：`http://localhost:3000/tool.html`
2. 输入提示词生成图片
3. 查看终端日志，应该看到：
   ```
   📥 下载图片 1...
   ☁️ 上传到R2: ai-generated/xxxxx.jpg
   ✅ 图片 1 已上传到R2: https://...
   ```
4. 生成的图片URL应该是R2的公开地址

---

## 🔧 配置文件说明

### `.env` 文件

```bash
# 通义万相API配置
TONGYI_API_KEY=your_tongyi_api_key_here

# Cloudflare R2 存储配置
R2_ACCOUNT_ID=your_r2_account_id_here
R2_ACCESS_KEY_ID=your_r2_access_key_id_here
R2_SECRET_ACCESS_KEY=your_r2_secret_access_key_here
R2_BUCKET_NAME=your_bucket_name
R2_ENDPOINT=https://your_account_id.r2.cloudflarestorage.com

# 公开访问URL（需要配置）
R2_PUBLIC_URL=https://pub-xxxxxx.r2.dev
# 或使用自定义域名：
# R2_PUBLIC_URL=https://images.yourdomain.com

# 服务器配置
PORT=3000
```

---

## 📁 文件存储结构

上传到R2的文件路径：
```
images/
└── ai-generated/
    ├── 1729500000-uuid1.jpg
    ├── 1729500001-uuid2.jpg
    └── ...
```

文件名格式：
```
{时间戳}-{UUID}.{扩展名}
```

元数据：
```json
{
  "prompt": "用户的提示词",
  "generated-at": "2025-10-20T12:34:56.789Z",
  "index": "0"
}
```

---

## 🔍 验证R2连接

启动服务器时会自动测试R2连接：

**成功**：
```
🔍 测试R2连接...
✅ R2连接成功
```

**失败**：
```
❌ R2连接失败: The authorization mechanism you have provided is not supported
请检查.env文件中的R2配置
```

---

## ⚠️ 常见问题

### Q1: 图片上传成功但无法访问

**原因**：R2存储桶未配置公开访问

**解决**：
1. 进入Cloudflare控制台
2. R2 → images → 设置 → 公共访问
3. 启用 r2.dev 域名或连接自定义域名

### Q2: 提示"Access Denied"

**原因**：R2 API密钥权限不足

**解决**：
1. 检查API密钥是否正确
2. 确认密钥有存储桶的读写权限

### Q3: 图片上传很慢

**原因**：需要先从通义万相下载图片，再上传到R2

**时间**：
- 通义万相生成：10-30秒
- 下载图片：2-5秒
- 上传到R2：2-5秒
- **总计**：约15-40秒

**优化**：使用并行处理（已实现）

### Q4: R2费用问题

**免费额度**（每月）：
- 存储：10GB
- Class A操作（写入）：100万次
- Class B操作（读取）：1000万次
- 出站流量：免费（CDN）

**预估**：
- 每张图片：~200KB
- 可存储：~50,000张图片
- 基本**完全免费**

### Q5: 如何查看已上传的图片

**方法1**：Cloudflare控制台
- R2 → images → 对象浏览器
- 查看 `ai-generated/` 目录

**方法2**：使用R2 API
```javascript
// 列出所有对象
const { ListObjectsV2Command } = require('@aws-sdk/client-s3');
const command = new ListObjectsV2Command({
    Bucket: 'images',
    Prefix: 'ai-generated/'
});
const result = await s3Client.send(command);
```

---

## 🔐 安全建议

### 1. 保护API密钥

- ✅ 使用 `.env` 文件存储密钥
- ✅ 已添加到 `.gitignore`
- ❌ 不要提交到Git
- ❌ 不要在前端暴露

### 2. 限制公开访问

- 仅开放必要的路径
- 使用自定义域名并配置CORS
- 考虑添加防盗链保护

### 3. 监控用量

- 定期检查R2用量
- 设置用量警报
- 防止滥用

---

## 📊 性能优化

### 1. 并行上传

已实现：同时上传多张图片到R2

### 2. 缓存优化

R2默认支持CDN缓存：
- 全球边缘节点
- 自动缓存热门内容
- 减少回源请求

### 3. 图片压缩

可选：在上传前压缩图片
```javascript
const sharp = require('sharp');
const compressed = await sharp(imageBuffer)
    .jpeg({ quality: 90 })
    .toBuffer();
```

---

## 🔄 回退到不使用R2

如果R2出现问题，可以临时回退：

**方法1**：使用旧服务器
```bash
node server.js
```

**方法2**：修改server-with-r2.js
注释掉R2上传部分，直接返回通义万相URL

---

## 📚 相关文档

- [Cloudflare R2文档](https://developers.cloudflare.com/r2/)
- [AWS S3 SDK文档](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/clients/client-s3/)
- [通义万相文档](https://help.aliyun.com/zh/dashscope/)

---

## ✅ 配置检查清单

- [ ] 已安装新依赖（npm install）
- [ ] 已创建 `.env` 文件
- [ ] 已配置R2公开访问
- [ ] 已获取R2公开URL
- [ ] 已更新 `.env` 中的 R2_PUBLIC_URL
- [ ] 已测试R2连接
- [ ] 已成功上传测试图片

---

需要帮助？请参考上面的常见问题或查看服务器日志！



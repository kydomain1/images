# 🚀 双平台部署指南（Vercel + Cloudflare）

## 📅 日期：2025-10-25

---

## 🎯 部署架构

### **项目结构**

```
D:\images\
├── api/                      # Vercel Functions (Node.js)
│   ├── tongyi-generate.js
│   └── remove-bg.js
│
├── functions/                # Cloudflare Workers (新增)
│   ├── tongyi-generate.js
│   └── remove-bg.js
│
├── index.html
├── tool.html
├── js/
├── css/
├── vercel.json              # Vercel配置
├── wrangler.toml            # Cloudflare配置
├── _headers                 # Cloudflare Headers
├── _redirects               # Cloudflare重定向
└── ...
```

### **平台对比**

| 特性 | Vercel | Cloudflare |
|------|--------|------------|
| 运行时 | Node.js | Workers (V8) |
| API目录 | `api/` | `functions/` |
| 配置文件 | `vercel.json` | `wrangler.toml`, `_redirects` |
| 环境变量 | Vercel Dashboard | Cloudflare Dashboard |
| 构建时间 | ~2分钟 | ~1分钟 |
| 全球CDN | ✅ | ✅ |

---

## 📝 第一步：提交代码

### **1. 查看新增文件**

```bash
git status
```

应该看到：
```
新文件:   functions/tongyi-generate.js
新文件:   functions/remove-bg.js
新文件:   wrangler.toml
新文件:   _headers
新文件:   _redirects
新文件:   .gitignore
修改:     api/tongyi-generate.js
修改:     js/api-config.js
修改:     vercel.json
```

### **2. 提交所有更改**

```bash
git add .
git commit -m "feat: 添加双平台支持 - Vercel和Cloudflare"
```

---

## 🟢 Vercel部署（平台1）

### **步骤1：推送到GitHub**

```bash
git push origin main
```

### **步骤2：自动部署**

Vercel会自动检测到更新：
- ✅ 检测 `vercel.json` 配置
- ✅ 使用 `api/` 目录的函数
- ✅ 应用环境变量（已配置）
- ✅ 1-2分钟后完成部署

### **步骤3：验证**

访问：`https://your-project.vercel.app/`
- 测试图片生成功能
- 检查API是否正常

---

## 🟠 Cloudflare部署（平台2）

### **方法1：通过GitHub连接（推荐）**

#### **步骤1：创建Cloudflare Pages项目**

1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 点击左侧 **"Workers & Pages"**
3. 点击 **"创建应用程序"**
4. 选择 **"Pages"** → **"连接到Git"**

#### **步骤2：连接GitHub仓库**

1. 授权Cloudflare访问GitHub
2. 选择您的 `images` 仓库
3. 点击 **"开始设置"**

#### **步骤3：配置构建设置**

```
项目名称: ai-image-tools
生产分支: main
框架预设: 无
构建命令: (留空)
构建输出目录: /
根目录: /
```

#### **步骤4：添加环境变量**

在 **"环境变量"** 部分添加：

| 变量名称 | 值 | 类型 |
|---------|---|------|
| `TONGYI_API_KEY` | 您的通义万相API密钥 | 加密 |
| `REMOVEBG_API_KEY` | 您的RemoveBG API密钥 | 加密 |

#### **步骤5：保存并部署**

1. 点击 **"保存并部署"**
2. 等待1-2分钟完成首次部署
3. 获得Cloudflare域名：`https://ai-image-tools.pages.dev`

---

### **方法2：通过Wrangler CLI（高级）**

#### **步骤1：安装Wrangler**

```bash
npm install -g wrangler
```

#### **步骤2：登录Cloudflare**

```bash
wrangler login
```

#### **步骤3：创建Pages项目**

```bash
wrangler pages project create ai-image-tools
```

#### **步骤4：部署**

```bash
wrangler pages deploy . --project-name=ai-image-tools
```

#### **步骤5：配置环境变量**

```bash
wrangler pages secret put TONGYI_API_KEY --project-name=ai-image-tools
wrangler pages secret put REMOVEBG_API_KEY --project-name=ai-image-tools
```

---

## ✅ 部署后验证

### **Vercel站点**
```
https://your-project.vercel.app/
```

### **Cloudflare站点**
```
https://ai-image-tools.pages.dev/
```

### **测试清单**

对**两个平台**分别测试：

- [ ] 访问首页
- [ ] 访问工具页
- [ ] 测试图片生成（通义万相API）
- [ ] 测试背景移除（RemoveBG API）
- [ ] 检查CSS/JS加载
- [ ] 测试多语言切换
- [ ] 检查响应速度

---

## 🔧 故障排查

### **Vercel问题**

**如果API调用失败：**
1. 检查Vercel Dashboard → Settings → Environment Variables
2. 确认 `TONGYI_API_KEY` 已配置
3. 查看 Deployments → Runtime Logs

**如果404错误：**
1. 检查 `vercel.json` 配置
2. 确认文件路径正确

---

### **Cloudflare问题**

**如果API调用失败：**
1. 检查 Cloudflare Pages → Settings → Environment Variables
2. 确认变量名称完全一致（区分大小写）
3. 查看 Workers → Logs

**如果函数超时：**
1. Cloudflare免费版限制：CPU时间50ms
2. 通义万相轮询可能超时
3. 考虑使用Cloudflare Workers Paid计划

---

## 🌐 自定义域名（可选）

### **Vercel自定义域名**

1. Vercel Dashboard → Settings → Domains
2. 添加您的域名
3. 配置DNS记录（CNAME）

### **Cloudflare自定义域名**

1. Cloudflare Pages → 自定义域
2. 添加域名
3. 自动配置DNS（如果域名在Cloudflare）

---

## 📊 双平台优势

### **✅ 冗余备份**
- 一个平台故障，另一个仍可用
- 提高整体可用性

### **✅ 性能优化**
- 可根据地区选择最快的平台
- Cloudflare: 全球边缘网络
- Vercel: 优化的CDN

### **✅ 负载分担**
- 可以使用负载均衡器
- 分流访问量

### **✅ A/B测试**
- 可以测试不同配置
- 比较性能差异

---

## 🔄 持续部署

### **推送代码自动部署**

```bash
# 修改代码后
git add .
git commit -m "更新功能"
git push origin main
```

**自动触发：**
- ✅ Vercel自动部署
- ✅ Cloudflare自动部署
- ⏱️ 约2-3分钟完成

---

## 📈 监控和分析

### **Vercel Analytics**
- Dashboard → Analytics
- 查看访问量、性能指标

### **Cloudflare Analytics**
- Pages → Analytics
- 查看请求数、带宽使用

---

## 💰 成本对比

### **Vercel**
- 免费版：个人项目足够
- Pro版：$20/月（团队使用）

### **Cloudflare**
- 免费版：无限请求（有CPU时间限制）
- Pro版：$5/月起

---

## 🎉 完成！

现在您的项目已经：
- ✅ 同时部署在Vercel和Cloudflare
- ✅ 两个独立域名访问
- ✅ 自动持续部署
- ✅ 高可用性保障

**推送代码后，两个平台都会在2-3分钟内完成部署！** 🚀

---

**部署指南创建时间：** 2025-10-25


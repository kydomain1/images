# 通义万相API接入完整指南

## 📋 准备工作

### 1. 注册阿里云账号
1. 访问：https://www.aliyun.com/
2. 点击"免费注册"
3. 完成手机号/邮箱注册
4. 完成实名认证（需要身份证）

### 2. 开通通义万相服务
1. 访问：https://dashscope.aliyun.com/
2. 使用阿里云账号登录
3. 点击"开通DashScope"服务
4. 新用户可获得 **100万Tokens免费额度**（约1000次图片生成）

### 3. 获取API Key

#### 方法A：使用DashScope控制台（推荐）
1. 登录：https://dashscope.console.aliyun.com/
2. 点击右上角头像 → "API-KEY管理"
3. 点击"创建新的API-KEY"
4. 复制生成的API Key（格式：sk-xxxxxxxxxxxxxxxx）
5. **重要**：妥善保存，只显示一次！

#### 方法B：使用阿里云RAM
1. 访问：https://ram.console.aliyun.com/
2. 创建RAM用户
3. 授予"AliyunDashScopeFullAccess"权限
4. 创建AccessKey

## 🔧 配置步骤

### 第一步：修改API配置文件

打开 `js/api-config.js`，进行以下修改：

```javascript
const API_CONFIG = {
    // 1. 将provider改为tongyi
    provider: 'tongyi',
    
    // 2. 配置通义万相
    tongyi: {
        apiKey: 'sk-你的真实API-KEY', // 粘贴你的API Key
        endpoint: 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text2image/image-synthesis'
    }
};
```

### 第二步：测试配置

1. 保存文件
2. 打开浏览器控制台（F12）
3. 打开 `tool.html`
4. 输入提示词："一只可爱的熊猫在吃竹子"
5. 点击"生成图片"
6. 查看控制台是否有错误

## 📝 完整代码实现

我已经为您创建了通义万相的集成代码，请查看 `js/tongyi-api.js` 文件。

## 🎯 使用示例

### 基础使用
```javascript
// 简单提示词
"一只可爱的橘猫坐在窗台上"

// 详细提示词（效果更好）
"一只可爱的橘猫坐在窗台上，阳光洒在它的身上，温暖的午后，油画风格，细节丰富，柔和的光线"
```

### 高级用法
```javascript
// 使用负面提示词
正面提示词: "美丽的风景画，高山流水，蓝天白云"
负面提示词: "模糊，低质量，变形，水印，文字"

// 指定风格
"赛博朋克风格的未来城市，霓虹灯，夜晚，科技感"
```

## 💰 费用说明

### 免费额度
- **新用户**：100万Tokens（约1000-2000张图片）
- **有效期**：3个月

### 付费价格（超出免费额度后）
- **wanx-v1**：0.08元/张（1024x1024）
- **wanx-sketch-to-image-v1**：0.08元/张
- **wanx-style-repaint-v1**：0.08元/张

### 查看用量
1. 访问：https://dashscope.console.aliyun.com/billing
2. 查看"用量统计"
3. 实时监控消费情况

## 🚀 API能力

通义万相支持的功能：

### 1. 文字生成图片 (Text-to-Image)
```javascript
// 已在项目中实现
{
    model: "wanx-v1",
    input: {
        prompt: "你的描述"
    },
    parameters: {
        size: "1024*1024",
        n: 1
    }
}
```

### 2. 图片风格重绘
```javascript
{
    model: "wanx-style-repaint-v1",
    input: {
        image_url: "原图URL",
        prompt: "风格描述"
    }
}
```

### 3. 草图转图片
```javascript
{
    model: "wanx-sketch-to-image-v1",
    input: {
        sketch_image_url: "草图URL",
        prompt: "详细描述"
    }
}
```

## ⚙️ 参数说明

### size（图片尺寸）
- `1024*1024`（正方形）
- `720*1280`（竖向）
- `1280*720`（横向）

### n（生成数量）
- 范围：1-4
- 建议：1-2（节省额度）

### seed（随机种子）
- 相同seed + 相同prompt = 相同图片
- 用于复现结果

### ref_mode（参考模式）
- `repaint`：重绘模式
- 默认：标准生成

## 🐛 常见问题解决

### Q1: "Invalid API Key" 错误
**解决方案**：
1. 检查API Key是否正确复制（sk-开头）
2. 确认API Key没有多余空格
3. 检查是否开通了DashScope服务
4. 尝试重新生成API Key

### Q2: "Insufficient Balance" 错误
**解决方案**：
1. 检查免费额度是否用完
2. 前往控制台充值
3. 查看账单明细

### Q3: 图片生成很慢
**解决方案**：
1. 通义万相生成时间约10-30秒
2. 建议单次生成1-2张图片
3. 避免高峰时段（工作日9-12点，14-18点）

### Q4: 提示词无法识别
**解决方案**：
1. 使用中文描述（通义万相对中文支持最好）
2. 描述要具体明确
3. 避免过于抽象的概念

### Q5: 跨域(CORS)错误
**解决方案**：
```javascript
// 这是正常的！通义万相API需要通过后端调用
// 请查看下面的"生产环境部署"章节
```

## 🔒 生产环境部署

**重要**：通义万相API不支持直接在浏览器调用（CORS限制），需要通过后端服务器。

### Node.js 后端示例

创建 `server.js`：

```javascript
const express = require('express');
const axios = require('axios');
const app = express();

app.use(express.json());

// 通义万相代理接口
app.post('/api/tongyi/generate', async (req, res) => {
    const { prompt, size, count } = req.body;
    
    try {
        const response = await axios.post(
            'https://dashscope.aliyuncs.com/api/v1/services/aigc/text2image/image-synthesis',
            {
                model: "wanx-v1",
                input: {
                    prompt: prompt
                },
                parameters: {
                    size: size || "1024*1024",
                    n: count || 1
                }
            },
            {
                headers: {
                    'Authorization': `Bearer ${process.env.TONGYI_API_KEY}`,
                    'Content-Type': 'application/json',
                    'X-DashScope-Async': 'enable'
                }
            }
        );
        
        res.json(response.data);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

app.listen(3000, () => {
    console.log('服务器运行在 http://localhost:3000');
});
```

启动服务器：
```bash
# 安装依赖
npm install express axios dotenv

# 设置环境变量
echo "TONGYI_API_KEY=你的API-KEY" > .env

# 启动服务器
node server.js
```

### Python Flask 后端示例

创建 `app.py`：

```python
from flask import Flask, request, jsonify
import requests
import os

app = Flask(__name__)

@app.route('/api/tongyi/generate', methods=['POST'])
def generate_image():
    data = request.json
    
    headers = {
        'Authorization': f'Bearer {os.getenv("TONGYI_API_KEY")}',
        'Content-Type': 'application/json',
        'X-DashScope-Async': 'enable'
    }
    
    payload = {
        'model': 'wanx-v1',
        'input': {
            'prompt': data['prompt']
        },
        'parameters': {
            'size': data.get('size', '1024*1024'),
            'n': data.get('count', 1)
        }
    }
    
    response = requests.post(
        'https://dashscope.aliyuncs.com/api/v1/services/aigc/text2image/image-synthesis',
        headers=headers,
        json=payload
    )
    
    return jsonify(response.json())

if __name__ == '__main__':
    app.run(port=3000)
```

启动服务器：
```bash
# 安装依赖
pip install flask requests python-dotenv

# 设置环境变量
export TONGYI_API_KEY=你的API-KEY

# 启动服务器
python app.py
```

## 📊 测试工具

我为您创建了测试脚本，请查看 `test-tongyi.html`

## 📚 官方文档

- **控制台**：https://dashscope.console.aliyun.com/
- **API文档**：https://help.aliyun.com/zh/dashscope/developer-reference/api-details-9
- **SDK文档**：https://help.aliyun.com/zh/dashscope/developer-reference/sdk-overview
- **定价说明**：https://help.aliyun.com/zh/dashscope/developer-reference/tongyi-wanxiang-metering-and-billing

## 🎉 完成检查清单

- [ ] 已注册阿里云账号
- [ ] 已完成实名认证
- [ ] 已开通DashScope服务
- [ ] 已获取API Key
- [ ] 已修改 `js/api-config.js` 配置
- [ ] 已测试图片生成功能
- [ ] 已了解费用情况

## 💡 优化建议

1. **提示词优化**：使用中文，描述详细
2. **成本控制**：设置每日生成上限
3. **异步处理**：通义万相支持异步生成，适合批量处理
4. **缓存策略**：相同提示词可缓存结果
5. **错误重试**：网络问题时自动重试

---

如有问题，请查看官方文档或联系阿里云客服。祝您使用愉快！🚀


